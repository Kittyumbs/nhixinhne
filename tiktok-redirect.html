<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M·ªü TikTok</title>
    <meta name="description" content="M·ªü video TikTok trong ·ª©ng d·ª•ng">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #FF0050 0%, #00F2EA 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .container {
            text-align: center;
            padding: 2rem;
            max-width: 400px;
        }

        .logo {
            width: 80px;
            height: 80px;
            background: white;
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 2rem;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
        }

        .logo svg {
            width: 48px;
            height: 48px;
        }

        h1 {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .subtitle {
            font-size: 0.9rem;
            opacity: 0.9;
            margin-bottom: 2rem;
        }

        .buttons {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 1rem;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            color: white;
        }

        .btn-primary {
            background: white;
            color: #FF0050;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
        }

        .btn-secondary {
            background: rgba(255,255,255,0.2);
            backdrop-filter: blur(10px);
        }

        .btn-secondary:hover {
            background: rgba(255,255,255,0.3);
        }

        .instructions {
            margin-top: 2rem;
            padding: 1rem;
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
            font-size: 0.8rem;
            line-height: 1.4;
        }

        .instructions strong {
            color: #FFE600;
        }

        .hidden {
            display: none !important;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="logo">
            <svg viewBox="0 0 24 24" fill="currentColor">
                <path d="M12.525.02c1.31-.02 2.61-.01 3.91-.02.08 1.53.63 3.09 1.75 4.17 1.12 1.11 2.7 1.62 4.24 1.79v4.03c-1.44-.05-2.89-.35-4.2-.97-.57-.26-1.1-.59-1.62-.93-.01 2.92.01 5.84-.02 8.75-.08 1.4-.54 2.79-1.35 3.94-1.31 1.92-3.58 3.17-5.91 2.87-2.33-.3-4.36-2.35-4.66-4.68-.3-2.33.57-4.6 2.49-5.91 1.15-.81 2.54-1.27 3.94-1.35.66-.04 1.32-.07 1.99-.11.01-3.05.01-6.11.01-9.16.08-.02.16-.02.22-.02z"/>
            </svg>
        </div>

        <h1>M·ªü TikTok</h1>
        <p class="subtitle">Xem video trong ·ª©ng d·ª•ng TikTok</p>

        <div class="buttons">
            <button id="openExternalBtn" class="btn btn-primary">
                <span id="btnText">M·ªü b·∫±ng tr√¨nh duy·ªát</span>
                <span id="btnLoading" class="loading hidden"></span>
            </button>

            <button id="copyLinkBtn" class="btn btn-secondary">
                <span>üìã</span>
                Sao ch√©p link
            </button>
        </div>

        <div id="instructions" class="instructions hidden">
            <strong>H∆∞·ªõng d·∫´n:</strong> Trong app Messenger/Instagram/TikTok, b·∫•m v√†o 3 ch·∫•m (‚ãØ) ·ªü g√≥c ph·∫£i ‚Üí <strong>M·ªü trong tr√¨nh duy·ªát</strong> ƒë·ªÉ t·ª± ƒë·ªông m·ªü app TikTok.
        </div>
    </div>

    <script>
        // Analytics tracking
        function trackEvent(eventName, data = {}) {
            console.log('üìä Track:', eventName, data);

            // You can integrate with Google Analytics, Facebook Pixel, etc.
            // For now, just console log
            if (typeof gtag !== 'undefined') {
                gtag('event', eventName, {
                    custom_parameter_1: data.browser_type || 'unknown',
                    custom_parameter_2: data.user_agent || 'unknown'
                });
            }
        }

        // Detect browser environment
        function detectBrowserEnvironment() {
            const userAgent = navigator.userAgent || navigator.vendor || window.opera;
            const isIOS = /iPad|iPhone|iPod/.test(userAgent) && !window.MSStream;
            const isAndroid = /android/i.test(userAgent);

            // Check for in-app browsers
            const inAppPatterns = [
                'FBAN', 'FBAV',     // Facebook
                'Instagram',         // Instagram
                'Messenger',         // Messenger
                'Line',              // Line
                'Twitter',          // Twitter
                'WhatsApp',         // WhatsApp
                'WeChat',           // WeChat
                'Snapchat',         // Snapchat
                'TikTok',           // TikTok in-app
                'LinkedIn',         // LinkedIn
                'Pinterest',        // Pinterest
                'Reddit'            // Reddit
            ];

            const isInAppBrowser = inAppPatterns.some(pattern => userAgent.includes(pattern));

            return {
                isIOS,
                isAndroid,
                isInAppBrowser,
                userAgent
            };
        }

        // Get URL parameter
        function getUrlParam(param) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(param);
        }

        // Main logic
        document.addEventListener('DOMContentLoaded', function() {
            const browserEnv = detectBrowserEnvironment();
            const tiktokUrl = getUrlParam('url');

            console.log('üåê Browser environment:', browserEnv);
            console.log('üîó TikTok URL:', tiktokUrl);

            trackEvent('view_go_page', {
                browser_type: browserEnv.isInAppBrowser ? 'in_app' : 'external',
                user_agent: browserEnv.userAgent.substring(0, 100),
                url: tiktokUrl
            });

            // If no URL provided, redirect to TikTok app store
            if (!tiktokUrl) {
                console.warn('No TikTok URL provided');
                window.location.href = browserEnv.isIOS
                    ? 'https://apps.apple.com/app/tiktok/id835599320'
                    : 'https://play.google.com/store/apps/details?id=com.zhiliaoapp.musically';
                return;
            }

            // Handle based on browser type
            if (!browserEnv.isInAppBrowser) {
                // External browser - auto redirect
                console.log('üåê External browser detected, auto-redirecting...');
                trackEvent('auto_redirect_external', { url: tiktokUrl });

                setTimeout(() => {
                    window.location.href = tiktokUrl;
                }, 500);
                return;
            }

            // In-app browser - show landing page with options
            console.log('üì± In-app browser detected, showing landing page');
            document.getElementById('instructions').classList.remove('hidden');

            // Setup button handlers
            setupButtonHandlers(tiktokUrl, browserEnv);
        });

        function setupButtonHandlers(tiktokUrl, browserEnv) {
            const openBtn = document.getElementById('openExternalBtn');
            const copyBtn = document.getElementById('copyLinkBtn');
            const btnText = document.getElementById('btnText');
            const btnLoading = document.getElementById('btnLoading');

            // Open external browser button
            openBtn.addEventListener('click', function() {
                console.log('üåê Opening external browser...');
                trackEvent('click_open_external_browser', { url: tiktokUrl });

                // Show loading
                btnText.textContent = 'ƒêang m·ªü...';
                btnLoading.classList.remove('hidden');

                // Attempt to open external browser
                openExternal(tiktokUrl, browserEnv);
            });

            // Copy link button
            copyBtn.addEventListener('click', async function() {
                console.log('üìã Copying link...');
                trackEvent('click_copy_link', { url: tiktokUrl });

                try {
                    await navigator.clipboard.writeText(tiktokUrl);
                    // Show feedback
                    const originalText = copyBtn.innerHTML;
                    copyBtn.innerHTML = '<span>‚úÖ</span> ƒê√£ sao ch√©p!';
                    setTimeout(() => {
                        copyBtn.innerHTML = originalText;
                    }, 2000);
                } catch (error) {
                    console.error('Error copying to clipboard:', error);
                    // Fallback for older browsers
                    const textArea = document.createElement('textarea');
                    textArea.value = tiktokUrl;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);

                    const originalText = copyBtn.innerHTML;
                    copyBtn.innerHTML = '<span>‚úÖ</span> ƒê√£ sao ch√©p!';
                    setTimeout(() => {
                        copyBtn.innerHTML = originalText;
                    }, 2000);
                }
            });
        }

        // Build Chrome intent URL for Android
        function buildChromeIntent(httpsUrl) {
            const u = new URL(httpsUrl);
            const fallback = encodeURIComponent(httpsUrl);
            return `intent://${u.host}${u.pathname}${u.search}#Intent;scheme=https;package=com.android.chrome;S.browser_fallback_url=${fallback};end`;
        }

        // Open external browser
        function openExternal(httpsUrl, browserEnv) {
            const ua = navigator.userAgent || '';
            const isAndroid = /Android/i.test(ua);
            const isIOS = /iPhone|iPad|iPod/i.test(ua);

            console.log('üåê Attempting to open external browser:', { isAndroid, isIOS, url: httpsUrl });

            if (isAndroid) {
                // Android: attempt Chrome intent
                try {
                    const intentUrl = buildChromeIntent(httpsUrl);
                    console.log('ü§ñ Android Chrome intent:', intentUrl);
                    trackEvent('open_external_attempt_android', { intent_url: intentUrl });

                    window.location.href = intentUrl;

                    // Track success (best effort)
                    setTimeout(() => {
                        trackEvent('open_external_attempt_success', { platform: 'android' });
                    }, 1000);

                } catch (error) {
                    console.error('‚ùå Android intent failed:', error);
                    // Fallback to direct URL
                    window.location.href = httpsUrl;
                }
                return;
            }

            if (isIOS) {
                // iOS: best effort with new tab (may still stay in webview)
                try {
                    console.log('üçé iOS attempt with window.open');
                    trackEvent('open_external_attempt_ios', { method: 'window_open' });

                    const w = window.open(httpsUrl, '_blank');
                    if (!w) {
                        console.log('‚ö†Ô∏è window.open blocked, trying direct redirect');
                        trackEvent('open_external_attempt_ios', { method: 'direct_redirect' });
                        window.location.href = httpsUrl;
                    } else {
                        trackEvent('open_external_attempt_success', { platform: 'ios' });
                    }
                } catch (error) {
                    console.error('‚ùå iOS attempt failed:', error);
                    // Fallback
                    window.location.href = httpsUrl;
                }
                return;
            }

            // Fallback for other platforms
            console.log('üîÑ Fallback: direct redirect');
            trackEvent('open_external_attempt_fallback', { platform: 'unknown' });
            window.location.href = httpsUrl;
        }

        async function tryDeepLink(url, browserEnv) {
            return new Promise((resolve, reject) => {
                try {
                    // For iOS, try Universal Link
                    if (browserEnv.isIOS) {
                        // iOS Universal Link for TikTok
                        window.location.href = url;
                    }
                    // For Android, try intent
                    else if (browserEnv.isAndroid) {
                        // Android intent for TikTok
                        window.location.href = `intent://tiktok.com${new URL(url).pathname}#Intent;scheme=https;package=com.zhiliaoapp.musically;end`;
                    }

                    // Resolve after a short delay
                    setTimeout(() => {
                        resolve();
                    }, 500);

                } catch (error) {
                    reject(error);
                }
            });
        }
    </script>
</body>
</html>
